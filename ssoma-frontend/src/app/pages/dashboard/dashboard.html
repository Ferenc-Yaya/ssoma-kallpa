<div class="dashboard-admin">

  <!-- Header -->
  <div class="header">
    <h1>Dashboard Administrador Kallpa</h1>
    <p class="subtitle">Gestión de Contratistas y Cumplimiento Documental</p>
  </div>

  <!-- Indicadores principales -->
  <div class="indicadores-principales">
    <div class="indicador contratistas" (click)="filtroEstado = 'todos'; onFiltroChange()">
      <mat-icon>business</mat-icon>
      <div class="indicador-info">
        <span class="numero">{{ totalContratistas }}</span>
        <span class="label">Contratistas</span>
      </div>
    </div>
    <div class="indicador contratos">
      <mat-icon>assignment</mat-icon>
      <div class="indicador-info">
        <span class="numero">{{ totalContratos }}</span>
        <span class="label">Contratos</span>
      </div>
    </div>
    <div class="indicador vencidos" (click)="filtroEstado = 'atencion'; onFiltroChange()">
      <mat-icon>error</mat-icon>
      <div class="indicador-info">
        <span class="numero">{{ totalDocumentosVencidos }}</span>
        <span class="label">Docs. Vencidos</span>
      </div>
    </div>
    <div class="indicador por-vencer">
      <mat-icon>schedule</mat-icon>
      <div class="indicador-info">
        <span class="numero">{{ totalDocumentosPorVencer }}</span>
        <span class="label">Docs. Por Vencer</span>
      </div>
    </div>
  </div>

  <!-- Resumen de estados -->
  <div class="resumen-estados" *ngIf="todosLosContratistas.length > 0">
    <div class="estado-card nuevo" (click)="filtroEstado = 'nuevo'; onFiltroChange()"
         [class.activo]="filtroEstado === 'nuevo'" *ngIf="resumenEstados.nuevos > 0">
      <span class="numero">{{ resumenEstados.nuevos }}</span>
      <span class="label">Nuevos</span>
    </div>
    <div class="estado-card atencion" (click)="filtroEstado = 'atencion'; onFiltroChange()"
         [class.activo]="filtroEstado === 'atencion'" *ngIf="resumenEstados.requierenAtencion > 0">
      <span class="numero">{{ resumenEstados.requierenAtencion }}</span>
      <span class="label">Req. Atención</span>
    </div>
    <div class="estado-card verde" (click)="filtroEstado = 'habilitado'; onFiltroChange()"
         [class.activo]="filtroEstado === 'habilitado'">
      <span class="numero">{{ resumenEstados.habilitados }}</span>
      <span class="label">Habilitados</span>
    </div>
    <div class="estado-card amarillo" (click)="filtroEstado = 'parcial'; onFiltroChange()"
         [class.activo]="filtroEstado === 'parcial'">
      <span class="numero">{{ resumenEstados.parciales }}</span>
      <span class="label">Parciales</span>
    </div>
    <div class="estado-card rojo" (click)="filtroEstado = 'bloqueado'; onFiltroChange()"
         [class.activo]="filtroEstado === 'bloqueado'">
      <span class="numero">{{ resumenEstados.bloqueados }}</span>
      <span class="label">Bloqueados</span>
    </div>
    <div class="estado-card total" (click)="filtroEstado = 'todos'; onFiltroChange()"
         [class.activo]="filtroEstado === 'todos'">
      <span class="numero">{{ resumenEstados.total }}</span>
      <span class="label">Total</span>
    </div>
  </div>

  <!-- Barra de búsqueda y filtros -->
  <div class="filtros-bar" *ngIf="todosLosContratistas.length > 0">
    <mat-form-field appearance="outline" class="search-field">
      <mat-label>Buscar contratista</mat-label>
      <input matInput [(ngModel)]="searchTerm" (ngModelChange)="onSearchChange()" placeholder="RUC, razón social o tipo...">
      <mat-icon matSuffix>search</mat-icon>
    </mat-form-field>

    <mat-form-field appearance="outline" class="filter-field">
      <mat-label>Estado</mat-label>
      <mat-select [(ngModel)]="filtroEstado" (ngModelChange)="onFiltroChange()">
        <mat-option value="todos">Todos los estados</mat-option>
        <mat-option value="nuevo">Nuevo</mat-option>
        <mat-option value="atencion">Requiere Atención</mat-option>
        <mat-option value="habilitado">Habilitado</mat-option>
        <mat-option value="parcial">Parcial</mat-option>
        <mat-option value="bloqueado">Bloqueado</mat-option>
      </mat-select>
    </mat-form-field>

    <span class="resultados-info">
      {{ contratistasFiltrados.length }} de {{ todosLosContratistas.length }} contratistas
    </span>
  </div>

  <!-- Sin contratistas -->
  <div class="sin-datos" *ngIf="todosLosContratistas.length === 0">
    <mat-icon>business</mat-icon>
    <h2>No hay contratistas registrados</h2>
    <p>Registra tu primer contratista para comenzar.</p>
  </div>

  <!-- Sin resultados de búsqueda -->
  <div class="sin-datos" *ngIf="todosLosContratistas.length > 0 && contratistasFiltrados.length === 0">
    <mat-icon>search_off</mat-icon>
    <h2>No se encontraron contratistas</h2>
    <p>Intenta con otros términos de búsqueda o cambia los filtros.</p>
  </div>

  <!-- Tabla de contratistas -->
  <div class="tabla-container" *ngIf="contratistasPaginados.length > 0">
    <table mat-table [dataSource]="contratistasPaginados" multiTemplateDataRows class="tabla-contratistas">

      <!-- Razón Social -->
      <ng-container matColumnDef="razonSocial">
        <th mat-header-cell *matHeaderCellDef>Contratista</th>
        <td mat-cell *matCellDef="let contratista">
          <button mat-button class="btn-expandir" (click)="toggleRow(contratista); $event.stopPropagation()">
            <mat-icon>{{ expandedElement === contratista ? 'expand_less' : 'expand_more' }}</mat-icon>
            <span class="nombre-contratista">{{ contratista.razonSocial }}</span>
          </button>
        </td>
      </ng-container>

      <!-- RUC -->
      <ng-container matColumnDef="ruc">
        <th mat-header-cell *matHeaderCellDef>RUC</th>
        <td mat-cell *matCellDef="let contratista">{{ contratista.ruc }}</td>
      </ng-container>

      <!-- Tipo -->
      <ng-container matColumnDef="tipo">
        <th mat-header-cell *matHeaderCellDef>Tipo</th>
        <td mat-cell *matCellDef="let contratista">{{ contratista.tipoContratista }}</td>
      </ng-container>

      <!-- Contratos -->
      <ng-container matColumnDef="contratos">
        <th mat-header-cell *matHeaderCellDef class="text-center">Contratos</th>
        <td mat-cell *matCellDef="let contratista" class="text-center">
          <span class="badge-contratos">{{ contratista.resumen.contratosActivos }}/{{ contratista.resumen.contratosTotal }}</span>
        </td>
      </ng-container>

      <!-- Vencidos -->
      <ng-container matColumnDef="vencidos">
        <th mat-header-cell *matHeaderCellDef class="text-center">Vencidos</th>
        <td mat-cell *matCellDef="let contratista" class="text-center">
          <span class="badge-vencidos" *ngIf="contratista.resumen.documentosVencidos > 0">
            {{ contratista.resumen.documentosVencidos }}
          </span>
          <span class="badge-ok" *ngIf="contratista.resumen.documentosVencidos === 0">-</span>
        </td>
      </ng-container>

      <!-- Por Vencer -->
      <ng-container matColumnDef="porVencer">
        <th mat-header-cell *matHeaderCellDef class="text-center">Por Vencer</th>
        <td mat-cell *matCellDef="let contratista" class="text-center">
          <span class="badge-por-vencer" *ngIf="contratista.resumen.documentosPorVencer > 0">
            {{ contratista.resumen.documentosPorVencer }}
          </span>
          <span class="badge-ok" *ngIf="contratista.resumen.documentosPorVencer === 0">-</span>
        </td>
      </ng-container>

      <!-- Cumplimiento -->
      <ng-container matColumnDef="cumplimiento">
        <th mat-header-cell *matHeaderCellDef class="text-center">Cumplimiento</th>
        <td mat-cell *matCellDef="let contratista" class="text-center">
          <span class="badge-cumplimiento" [class]="getCumplimientoClass(contratista.porcentajeCumplimiento)">
            {{ contratista.porcentajeCumplimiento }}%
          </span>
        </td>
      </ng-container>

      <!-- Acciones -->
      <ng-container matColumnDef="acciones">
        <th mat-header-cell *matHeaderCellDef></th>
        <td mat-cell *matCellDef="let contratista">
          <button mat-icon-button color="primary" matTooltip="Ver detalle" (click)="verDetalleContratista(contratista); $event.stopPropagation()">
            <mat-icon>visibility</mat-icon>
          </button>
        </td>
      </ng-container>

      <!-- Fila expandida con contratos -->
      <ng-container matColumnDef="expandedDetail">
        <td mat-cell *matCellDef="let contratista" [attr.colspan]="displayedColumns.length">
          <div class="detalle-contratos" [@detailExpand]="contratista === expandedElement ? 'expanded' : 'collapsed'">
            <div class="contratos-wrapper">
              <h4>Contratos de {{ contratista.razonSocial }}</h4>
              <table class="tabla-contratos-detalle">
                <thead>
                  <tr>
                    <th></th>
                    <th>N° Contrato</th>
                    <th>Descripción</th>
                    <th>Sede</th>
                    <th>Estado</th>
                    <th>Personal</th>
                    <th>Vehículos</th>
                    <th>Equipos</th>
                    <th>Cumplimiento</th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let contrato of contratista.contratos">
                    <td>
                      <div class="semaforo-mini" [class]="getContratoSemaforoColor(contrato)"></div>
                    </td>
                    <td class="numero-contrato">{{ contrato.numero }}</td>
                    <td>{{ contrato.descripcion }}</td>
                    <td>
                      <span class="sede-badge">
                        <mat-icon>location_on</mat-icon>
                        {{ contrato.sede }}
                      </span>
                    </td>
                    <td class="text-center">
                      <span class="estado-badge-mini" [class]="contrato.estado">
                        {{ getEstadoLabel(contrato.estado) }}
                      </span>
                    </td>
                    <td class="text-center">{{ contrato.personal.habilitados }}/{{ contrato.personal.total }}</td>
                    <td class="text-center">{{ contrato.vehiculos.habilitados }}/{{ contrato.vehiculos.total }}</td>
                    <td class="text-center">{{ contrato.herramientas.habilitados }}/{{ contrato.herramientas.total }}</td>
                    <td class="text-center">
                      <span class="badge-cumplimiento-mini" [class]="getCumplimientoClass(contrato.porcentajeCumplimiento)">
                        {{ contrato.porcentajeCumplimiento }}%
                      </span>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </td>
      </ng-container>

      <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
      <tr mat-row *matRowDef="let contratista; columns: displayedColumns;"
          class="contratista-row"
          [class.expanded-row]="expandedElement === contratista"
          (click)="toggleRow(contratista)">
      </tr>
      <tr mat-row *matRowDef="let row; columns: ['expandedDetail']" class="detail-row"></tr>
    </table>
  </div>

  <!-- Paginación -->
  <mat-paginator *ngIf="contratistasFiltrados.length > 0"
    [length]="contratistasFiltrados.length"
    [pageSize]="pageSize"
    [pageIndex]="pageIndex"
    [pageSizeOptions]="[10, 20, 50]"
    (page)="onPageChange($event)"
    showFirstLastButtons>
  </mat-paginator>

</div>
