<div class="dashboard">
  <!-- Fila 1: 6 Tarjetas KPI -->
  <div class="kpi-cards">
    <mat-card class="kpi-card">
      <mat-card-content>
        <div class="kpi-layout">
          <div class="kpi-icon-container primary">
            <mat-icon>business</mat-icon>
          </div>
          <div class="kpi-content">
            <h2 class="kpi-number">{{ stats.totalEmpresasProveedoras }}</h2>
            <p class="kpi-label">Total Empresas Proveedoras</p>
          </div>
        </div>
      </mat-card-content>
    </mat-card>

    <mat-card class="kpi-card">
      <mat-card-content>
        <div class="kpi-layout">
          <div class="kpi-icon-container accent">
            <mat-icon>people</mat-icon>
          </div>
          <div class="kpi-content">
            <h2 class="kpi-number">{{ stats.totalEmpleados }}</h2>
            <p class="kpi-label">Total Empleados</p>
          </div>
        </div>
      </mat-card-content>
    </mat-card>

    <mat-card class="kpi-card">
      <mat-card-content>
        <div class="kpi-layout">
          <div class="kpi-icon-container tools">
            <mat-icon>build</mat-icon>
          </div>
          <div class="kpi-content">
            <h2 class="kpi-number">{{ stats.totalActivos }}</h2>
            <p class="kpi-label">Total Activos (H+V)</p>
          </div>
        </div>
      </mat-card-content>
    </mat-card>

    <mat-card class="kpi-card">
      <mat-card-content>
        <div class="kpi-layout">
          <div class="kpi-icon-container warn">
            <mat-icon>warning</mat-icon>
          </div>
          <div class="kpi-content">
            <h2 class="kpi-number">{{ stats.materialesPeligrosos }}</h2>
            <p class="kpi-label">Materiales Peligrosos</p>
          </div>
        </div>
      </mat-card-content>
    </mat-card>

    <mat-card class="kpi-card">
      <mat-card-content>
        <div class="kpi-layout">
          <div class="kpi-icon-container success">
            <mat-icon>assignment</mat-icon>
          </div>
          <div class="kpi-content">
            <h2 class="kpi-number">{{ stats.contratosActivos }}</h2>
            <p class="kpi-label">Contratos Activos</p>
          </div>
        </div>
      </mat-card-content>
    </mat-card>

    <mat-card class="kpi-card alert">
      <mat-card-content>
        <div class="kpi-layout">
          <div class="kpi-icon-container danger">
            <mat-icon>description</mat-icon>
          </div>
          <div class="kpi-content">
            <h2 class="kpi-number danger">{{ stats.documentosVencidos }}</h2>
            <p class="kpi-label">Documentos Vencidos</p>
          </div>
        </div>
      </mat-card-content>
    </mat-card>
  </div>

  <div class="dashboard-grid">
    <!-- Semáforo Corporativo -->
    <mat-card class="semaforo-card">
      <mat-card-header>
        <mat-card-title>
          <mat-icon>traffic</mat-icon>
          Semáforo Corporativo
        </mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <div class="chart-wrapper">
          <div class="chart-container">
            <canvas id="semaforoChart"></canvas>
          </div>
          <div class="semaforo-stats">
            <div class="stat-item">
              <span class="stat-indicator green"></span>
              <span class="stat-label">Apto</span>
              <span class="stat-number green">{{ stats.semaforo.apto }}%</span>
            </div>
            <div class="stat-item">
              <span class="stat-indicator yellow"></span>
              <span class="stat-label">Pendiente</span>
              <span class="stat-number yellow">{{ stats.semaforo.pendiente }}%</span>
            </div>
            <div class="stat-item">
              <span class="stat-indicator red"></span>
              <span class="stat-label">Bloqueado</span>
              <span class="stat-number red">{{ stats.semaforo.bloqueado }}%</span>
            </div>
          </div>
        </div>
      </mat-card-content>
    </mat-card>

    <!-- Top 5 Observaciones -->
    <mat-card class="observaciones-card">
      <mat-card-header>
        <mat-card-title>
          <mat-icon>warning</mat-icon>
          Top 5 Observaciones
        </mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <table mat-table [dataSource]="stats.topObservaciones" class="observaciones-table">

          <ng-container matColumnDef="posicion">
            <th mat-header-cell *matHeaderCellDef>#</th>
            <td mat-cell *matCellDef="let item">{{ item.posicion }}</td>
          </ng-container>

          <ng-container matColumnDef="empresa">
            <th mat-header-cell *matHeaderCellDef>Empresa</th>
            <td mat-cell *matCellDef="let item">{{ item.empresa }}</td>
          </ng-container>

          <ng-container matColumnDef="documentosVencidos">
            <th mat-header-cell *matHeaderCellDef>Doc. Vencidos</th>
            <td mat-cell *matCellDef="let item">
              <strong class="text-danger">{{ item.documentosVencidos }}</strong>
            </td>
          </ng-container>

          <ng-container matColumnDef="documentosFaltantes">
            <th mat-header-cell *matHeaderCellDef>Doc. Faltantes</th>
            <td mat-cell *matCellDef="let item">
              <strong class="text-warning">{{ item.documentosFaltantes }}</strong>
            </td>
          </ng-container>

          <ng-container matColumnDef="semaforo">
            <th mat-header-cell *matHeaderCellDef>Semáforo</th>
            <td mat-cell *matCellDef="let item">
              <span
                class="semaforo-badge"
                [class.semaforo-rojo]="item.colorSemaforo === 'ROJO'"
                [class.semaforo-amarillo]="item.colorSemaforo === 'AMARILLO'"
                [class.semaforo-verde]="item.colorSemaforo === 'VERDE'">
                {{ item.colorSemaforo }}
              </span>
            </td>
          </ng-container>

          <tr mat-header-row *matHeaderRowDef="displayedColumnsObservaciones"></tr>
          <tr mat-row *matRowDef="let row; columns: displayedColumnsObservaciones;"></tr>
        </table>
      </mat-card-content>
    </mat-card>
  </div>

  <!-- Proveedores y Contratos -->
  <mat-card class="proveedores-card">
    <mat-card-header>
      <mat-card-title>
        <mat-icon>folder_shared</mat-icon>
        Proveedores y Contratos
      </mat-card-title>
    </mat-card-header>
    <mat-card-content>
      <!-- Filtros -->
      <div class="filtros-container">
        <mat-form-field class="filtro-search">
          <mat-icon matPrefix>search</mat-icon>
          <input matInput placeholder="Buscar proveedor..." [(ngModel)]="searchText" (ngModelChange)="aplicarFiltros()">
        </mat-form-field>

        <mat-form-field class="filtro-select">
          <mat-select [(ngModel)]="filterEstado" (ngModelChange)="aplicarFiltros()" placeholder="Todos los estados">
            <mat-option value="todos">Todos los estados</mat-option>
            <mat-option value="APTO">APTO</mat-option>
            <mat-option value="PENDIENTE">PENDIENTE</mat-option>
            <mat-option value="BLOQUEADO">BLOQUEADO</mat-option>
          </mat-select>
        </mat-form-field>

        <button mat-button (click)="limpiarFiltros()" class="btn-limpiar">
          Limpiar filtros
        </button>
      </div>

      <!-- Tabla de proveedores -->
      <div class="tabla-proveedores-wrapper">
        <table mat-table [dataSource]="proveedoresFiltrados" multiTemplateDataRows class="proveedores-table">

          <ng-container matColumnDef="proveedor">
            <th mat-header-cell *matHeaderCellDef>Proveedor</th>
            <td mat-cell *matCellDef="let item">
              <button mat-button class="proveedor-expandable" (click)="toggleRow(item)">
                <mat-icon>{{ expandedElement === item ? 'arrow_drop_up' : 'arrow_drop_down' }}</mat-icon>
                {{ item.proveedor }}
              </button>
            </td>
          </ng-container>

          <ng-container matColumnDef="empleados">
            <th mat-header-cell *matHeaderCellDef>Empleados</th>
            <td mat-cell *matCellDef="let item">{{ item.empleados }}</td>
          </ng-container>

          <ng-container matColumnDef="activos">
            <th mat-header-cell *matHeaderCellDef>Activos</th>
            <td mat-cell *matCellDef="let item">{{ item.activos }}</td>
          </ng-container>

          <ng-container matColumnDef="materialesPeligrosos">
            <th mat-header-cell *matHeaderCellDef>Mat. Peligrosos</th>
            <td mat-cell *matCellDef="let item">{{ item.materialesPeligrosos }}</td>
          </ng-container>

          <ng-container matColumnDef="contratos">
            <th mat-header-cell *matHeaderCellDef>Contratos</th>
            <td mat-cell *matCellDef="let item">
              <span class="contratos-badge">{{ item.contratos }} Contratos</span>
            </td>
          </ng-container>

          <ng-container matColumnDef="acreditacion">
            <th mat-header-cell *matHeaderCellDef>Acreditación</th>
            <td mat-cell *matCellDef="let item">
              <span class="acreditacion-text">{{ item.acreditacion }}%</span>
            </td>
          </ng-container>

          <!-- Fila expandible con detalle de contratos -->
          <ng-container matColumnDef="expandedDetail">
            <td mat-cell *matCellDef="let item" [attr.colspan]="displayedColumnsProveedores.length">
              <div class="detalle-contratos" [@detailExpand]="item == expandedElement ? 'expanded' : 'collapsed'">
                <table class="tabla-contratos">
                  <thead>
                    <tr>
                      <th>N° Contrato</th>
                      <th>Descripción</th>
                      <th>Empleados</th>
                      <th>Activos</th>
                      <th>Mat. Pel.</th>
                      <th>Fecha Inicio</th>
                      <th>Fecha Fin</th>
                      <th>Estado Contrato</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr *ngFor="let contrato of item.detalleContratos">
                      <td>{{ contrato.numeroContrato }}</td>
                      <td>{{ contrato.descripcion }}</td>
                      <td>{{ contrato.empleados }}</td>
                      <td>{{ contrato.activos }}</td>
                      <td>{{ contrato.materialesPel }}</td>
                      <td>{{ contrato.fechaInicio }}</td>
                      <td>{{ contrato.fechaFin }}</td>
                      <td>
                        <span
                          class="contrato-estado-badge"
                          [class.contrato-activa]="contrato.estadoContrato === 'ACTIVA'"
                          [class.contrato-pendiente]="contrato.estadoContrato === 'PENDIENTE'"
                          [class.contrato-porvencer]="contrato.estadoContrato === 'POR VENCER'">
                          {{ contrato.estadoContrato }}
                        </span>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </td>
          </ng-container>

          <tr mat-header-row *matHeaderRowDef="displayedColumnsProveedores"></tr>
          <tr mat-row *matRowDef="let row; columns: displayedColumnsProveedores;" class="proveedor-row"></tr>
          <tr mat-row *matRowDef="let row; columns: ['expandedDetail']" class="detalle-row"></tr>
        </table>
      </div>

      <div class="tabla-footer">
        <span>Mostrando {{ proveedoresFiltrados.length }} de {{ stats.proveedores.length }} proveedores</span>
      </div>
    </mat-card-content>
  </mat-card>
</div>
