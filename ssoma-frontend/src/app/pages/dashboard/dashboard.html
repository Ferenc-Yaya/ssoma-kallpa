<div class="dashboard-admin">

  <!-- Header -->
  <div class="header">
    <h1>Dashboard Administrador Kallpa</h1>
    <p class="subtitle">Gestión de Contratistas y Cumplimiento Documental</p>
  </div>

  <!-- Indicadores principales -->
  <div class="indicadores-principales">
    <div class="indicador contratistas" (click)="filtroEstado = 'todos'; onFiltroChange()">
      <mat-icon>business</mat-icon>
      <div class="indicador-info">
        <span class="numero">{{ totalContratistas }}</span>
        <span class="label">Contratistas</span>
      </div>
    </div>
    <div class="indicador contratos">
      <mat-icon>assignment</mat-icon>
      <div class="indicador-info">
        <span class="numero">{{ totalContratos }}</span>
        <span class="label">Contratos</span>
      </div>
    </div>
    <div class="indicador aprobados" (click)="abrirPanelDocumentos('aprobados')">
      <mat-icon>check_circle</mat-icon>
      <div class="indicador-info">
        <span class="numero">{{ totalDocumentosAprobados }}</span>
        <span class="label">Docs. Aprobados</span>
      </div>
    </div>
    <div class="indicador en-revision" (click)="abrirPanelDocumentos('en_revision')">
      <mat-icon>hourglass_empty</mat-icon>
      <div class="indicador-info">
        <span class="numero">{{ totalDocumentosEnRevision }}</span>
        <span class="label">En Revisión</span>
      </div>
    </div>
    <div class="indicador observados" (click)="abrirPanelDocumentos('observados')">
      <mat-icon>visibility</mat-icon>
      <div class="indicador-info">
        <span class="numero">{{ totalDocumentosObservados }}</span>
        <span class="label">Observados</span>
      </div>
    </div>
    <div class="indicador vencidos" (click)="abrirPanelDocumentos('vencidos')">
      <mat-icon>error</mat-icon>
      <div class="indicador-info">
        <span class="numero">{{ totalDocumentosVencidos }}</span>
        <span class="label">Docs. Vencidos</span>
      </div>
    </div>
    <div class="indicador por-vencer" (click)="abrirPanelDocumentos('por_vencer')">
      <mat-icon>schedule</mat-icon>
      <div class="indicador-info">
        <span class="numero">{{ totalDocumentosPorVencer }}</span>
        <span class="label">Por Vencer</span>
      </div>
    </div>
  </div>

  <!-- Barra de búsqueda y filtros -->
  <div class="filtros-bar" *ngIf="!vistaDocumentos && todosLosContratistas.length > 0">
    <div class="search-bar">
      <mat-icon>search</mat-icon>
      <input type="text"
             placeholder="Buscar por RUC, razón social o tipo..."
             [(ngModel)]="searchTerm"
             (ngModelChange)="onSearchChange()">
      <button mat-icon-button *ngIf="searchTerm" (click)="searchTerm = ''; onSearchChange()" matTooltip="Limpiar búsqueda">
        <mat-icon>close</mat-icon>
      </button>
    </div>

    <div class="filter-select">
      <mat-icon>filter_list</mat-icon>
      <select [(ngModel)]="filtroEstado" (ngModelChange)="onFiltroChange()">
        <option value="todos">Todos los estados</option>
        <option value="nuevo">Nuevo</option>
        <option value="atencion">Requiere Atención</option>
        <option value="habilitado">Habilitado</option>
        <option value="parcial">Parcial</option>
        <option value="bloqueado">Bloqueado</option>
      </select>
    </div>

    <span class="resultados-info">
      {{ contratistasFiltrados.length }} de {{ todosLosContratistas.length }} contratistas
    </span>
  </div>

  <!-- Sin contratistas -->
  <div class="sin-datos" *ngIf="!vistaDocumentos && todosLosContratistas.length === 0">
    <mat-icon>business</mat-icon>
    <h2>No hay contratistas registrados</h2>
    <p>Registra tu primer contratista para comenzar.</p>
  </div>

  <!-- Sin resultados de búsqueda -->
  <div class="sin-datos" *ngIf="!vistaDocumentos && todosLosContratistas.length > 0 && contratistasFiltrados.length === 0">
    <mat-icon>search_off</mat-icon>
    <h2>No se encontraron contratistas</h2>
    <p>Intenta con otros términos de búsqueda o cambia los filtros.</p>
  </div>

  <!-- Tabla de contratistas -->
  <div class="tabla-container" *ngIf="!vistaDocumentos && contratistasPaginados.length > 0">
    <table mat-table [dataSource]="contratistasPaginados" multiTemplateDataRows class="tabla-contratistas">

      <!-- Razón Social -->
      <ng-container matColumnDef="razonSocial">
        <th mat-header-cell *matHeaderCellDef>Contratista</th>
        <td mat-cell *matCellDef="let contratista">
          <button mat-button class="btn-expandir" (click)="toggleRow(contratista); $event.stopPropagation()">
            <mat-icon>{{ expandedElement === contratista ? 'expand_less' : 'expand_more' }}</mat-icon>
            <span class="nombre-contratista">{{ contratista.razonSocial }}</span>
          </button>
        </td>
      </ng-container>

      <!-- RUC -->
      <ng-container matColumnDef="ruc">
        <th mat-header-cell *matHeaderCellDef>RUC</th>
        <td mat-cell *matCellDef="let contratista">{{ contratista.ruc }}</td>
      </ng-container>

      <!-- Tipo -->
      <ng-container matColumnDef="tipo">
        <th mat-header-cell *matHeaderCellDef>Tipo</th>
        <td mat-cell *matCellDef="let contratista">{{ contratista.tipoContratista }}</td>
      </ng-container>

      <!-- Contratos -->
      <ng-container matColumnDef="contratos">
        <th mat-header-cell *matHeaderCellDef class="text-center">Contratos</th>
        <td mat-cell *matCellDef="let contratista" class="text-center">
          <span class="badge-contratos">{{ contratista.resumen.contratosActivos }}/{{ contratista.resumen.contratosTotal }}</span>
        </td>
      </ng-container>

      <!-- Aprobados -->
      <ng-container matColumnDef="aprobados">
        <th mat-header-cell *matHeaderCellDef class="text-center">Aprobados</th>
        <td mat-cell *matCellDef="let contratista" class="text-center">
          <span class="badge-aprobados" *ngIf="contratista.resumen.documentosAprobados > 0">
            {{ contratista.resumen.documentosAprobados }}
          </span>
          <span class="badge-ok" *ngIf="contratista.resumen.documentosAprobados === 0">-</span>
        </td>
      </ng-container>

      <!-- En Revisión -->
      <ng-container matColumnDef="enRevision">
        <th mat-header-cell *matHeaderCellDef class="text-center">En Revisión</th>
        <td mat-cell *matCellDef="let contratista" class="text-center">
          <span class="badge-en-revision" *ngIf="contratista.resumen.documentosEnRevision > 0">
            {{ contratista.resumen.documentosEnRevision }}
          </span>
          <span class="badge-ok" *ngIf="contratista.resumen.documentosEnRevision === 0">-</span>
        </td>
      </ng-container>

      <!-- Observados -->
      <ng-container matColumnDef="observados">
        <th mat-header-cell *matHeaderCellDef class="text-center">Observados</th>
        <td mat-cell *matCellDef="let contratista" class="text-center">
          <span class="badge-observados" *ngIf="contratista.resumen.documentosObservados > 0">
            {{ contratista.resumen.documentosObservados }}
          </span>
          <span class="badge-ok" *ngIf="contratista.resumen.documentosObservados === 0">-</span>
        </td>
      </ng-container>

      <!-- Vencidos -->
      <ng-container matColumnDef="vencidos">
        <th mat-header-cell *matHeaderCellDef class="text-center">Vencidos</th>
        <td mat-cell *matCellDef="let contratista" class="text-center">
          <span class="badge-vencidos" *ngIf="contratista.resumen.documentosVencidos > 0">
            {{ contratista.resumen.documentosVencidos }}
          </span>
          <span class="badge-ok" *ngIf="contratista.resumen.documentosVencidos === 0">-</span>
        </td>
      </ng-container>

      <!-- Por Vencer -->
      <ng-container matColumnDef="porVencer">
        <th mat-header-cell *matHeaderCellDef class="text-center">Por Vencer</th>
        <td mat-cell *matCellDef="let contratista" class="text-center">
          <span class="badge-por-vencer" *ngIf="contratista.resumen.documentosPorVencer > 0">
            {{ contratista.resumen.documentosPorVencer }}
          </span>
          <span class="badge-ok" *ngIf="contratista.resumen.documentosPorVencer === 0">-</span>
        </td>
      </ng-container>

      <!-- Cumplimiento -->
      <ng-container matColumnDef="cumplimiento">
        <th mat-header-cell *matHeaderCellDef class="text-center">Cumplimiento</th>
        <td mat-cell *matCellDef="let contratista" class="text-center">
          <span class="badge-cumplimiento" [class]="getCumplimientoClass(contratista.porcentajeCumplimiento)">
            {{ contratista.porcentajeCumplimiento }}%
          </span>
        </td>
      </ng-container>

      <!-- Acciones -->
      <ng-container matColumnDef="acciones">
        <th mat-header-cell *matHeaderCellDef></th>
        <td mat-cell *matCellDef="let contratista">
          <button mat-icon-button color="primary" matTooltip="Ver detalle" (click)="verDetalleContratista(contratista); $event.stopPropagation()">
            <mat-icon>visibility</mat-icon>
          </button>
        </td>
      </ng-container>

      <!-- Fila expandida con contratos -->
      <ng-container matColumnDef="expandedDetail">
        <td mat-cell *matCellDef="let contratista" [attr.colspan]="displayedColumns.length">
          <div class="detalle-contratos" [@detailExpand]="contratista === expandedElement ? 'expanded' : 'collapsed'">
            <div class="contratos-wrapper">
              <h4>Contratos de {{ contratista.razonSocial }}</h4>
              <table class="tabla-contratos-detalle">
                <thead>
                  <tr>
                    <th></th>
                    <th>N° Contrato</th>
                    <th>Descripción</th>
                    <th>Sede</th>
                    <th>Estado</th>
                    <th>Personal</th>
                    <th>Vehículos</th>
                    <th>Equipos</th>
                    <th>Cumplimiento</th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let contrato of contratista.contratos">
                    <td>
                      <div class="semaforo-mini" [class]="getContratoSemaforoColor(contrato)"></div>
                    </td>
                    <td class="numero-contrato">{{ contrato.numero }}</td>
                    <td>{{ contrato.descripcion }}</td>
                    <td>
                      <span class="sede-badge">
                        <mat-icon>location_on</mat-icon>
                        {{ contrato.sede }}
                      </span>
                    </td>
                    <td class="text-center">
                      <span class="estado-badge-mini" [class]="contrato.estado">
                        {{ getEstadoLabel(contrato.estado) }}
                      </span>
                    </td>
                    <td class="text-center">{{ contrato.personal.habilitados }}/{{ contrato.personal.total }}</td>
                    <td class="text-center">{{ contrato.vehiculos.habilitados }}/{{ contrato.vehiculos.total }}</td>
                    <td class="text-center">{{ contrato.herramientas.habilitados }}/{{ contrato.herramientas.total }}</td>
                    <td class="text-center">
                      <span class="badge-cumplimiento-mini" [class]="getCumplimientoClass(contrato.porcentajeCumplimiento)">
                        {{ contrato.porcentajeCumplimiento }}%
                      </span>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </td>
      </ng-container>

      <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
      <tr mat-row *matRowDef="let contratista; columns: displayedColumns;"
          class="contratista-row"
          [class.expanded-row]="expandedElement === contratista"
          (click)="toggleRow(contratista)">
      </tr>
      <tr mat-row *matRowDef="let row; columns: ['expandedDetail']" class="detail-row"></tr>
    </table>
  </div>

  <!-- Paginación contratistas -->
  <mat-paginator *ngIf="!vistaDocumentos && contratistasFiltrados.length > 0"
    [length]="contratistasFiltrados.length"
    [pageSize]="pageSize"
    [pageIndex]="pageIndex"
    [pageSizeOptions]="[10, 20, 50]"
    (page)="onPageChange($event)"
    showFirstLastButtons>
  </mat-paginator>

  <!-- Tabla de documentos filtrados -->
  <div class="tabla-container" *ngIf="vistaDocumentos">
    <div class="tabla-header-docs">
      <h3>{{ panelTitulo }}</h3>
      <span class="docs-count">{{ documentosFiltrados.length }} documentos</span>
      <button mat-stroked-button (click)="cerrarVistaDocumentos()">
        <mat-icon>arrow_back</mat-icon>
        Volver a Contratistas
      </button>
    </div>

    <table mat-table [dataSource]="documentosPaginados" class="tabla-documentos">
      <!-- Tipo -->
      <ng-container matColumnDef="tipo">
        <th mat-header-cell *matHeaderCellDef>Tipo</th>
        <td mat-cell *matCellDef="let doc">
          <div class="tipo-icono" [class]="doc.tipo">
            <mat-icon>{{ getTipoDocumentoIcon(doc.tipo) }}</mat-icon>
          </div>
        </td>
      </ng-container>

      <!-- Documento -->
      <ng-container matColumnDef="documento">
        <th mat-header-cell *matHeaderCellDef>Documento</th>
        <td mat-cell *matCellDef="let doc">
          <span class="doc-nombre">{{ doc.nombre }}</span>
        </td>
      </ng-container>

      <!-- Entidad -->
      <ng-container matColumnDef="entidad">
        <th mat-header-cell *matHeaderCellDef>Entidad</th>
        <td mat-cell *matCellDef="let doc">{{ doc.entidad || '-' }}</td>
      </ng-container>

      <!-- Contratista -->
      <ng-container matColumnDef="contratista">
        <th mat-header-cell *matHeaderCellDef>Contratista</th>
        <td mat-cell *matCellDef="let doc">{{ doc.contratista }}</td>
      </ng-container>

      <!-- Contrato -->
      <ng-container matColumnDef="contrato">
        <th mat-header-cell *matHeaderCellDef>Contrato</th>
        <td mat-cell *matCellDef="let doc">
          <span class="contrato-num">{{ doc.contratoNumero }}</span>
        </td>
      </ng-container>

      <!-- Estado -->
      <ng-container matColumnDef="estado">
        <th mat-header-cell *matHeaderCellDef class="text-center">Estado</th>
        <td mat-cell *matCellDef="let doc" class="text-center">
          <span class="estado-badge-doc" [class]="getEstadoDocumentoClass(doc.estado)">
            {{ getEstadoDocumentoLabel(doc.estado) }}
          </span>
        </td>
      </ng-container>

      <!-- Vencimiento -->
      <ng-container matColumnDef="vencimiento">
        <th mat-header-cell *matHeaderCellDef class="text-center">Vencimiento</th>
        <td mat-cell *matCellDef="let doc" class="text-center">
          <span *ngIf="doc.diasRestantes !== undefined" class="dias-badge"
                [class.vencido]="doc.diasRestantes < 0"
                [class.urgente]="doc.diasRestantes >= 0 && doc.diasRestantes <= 7"
                [class.proximo]="doc.diasRestantes > 7">
            <ng-container *ngIf="doc.diasRestantes < 0">Hace {{ doc.diasRestantes * -1 }} días</ng-container>
            <ng-container *ngIf="doc.diasRestantes >= 0">En {{ doc.diasRestantes }} días</ng-container>
          </span>
          <span *ngIf="doc.diasRestantes === undefined">-</span>
        </td>
      </ng-container>

      <tr mat-header-row *matHeaderRowDef="columnasDocumentos"></tr>
      <tr mat-row *matRowDef="let row; columns: columnasDocumentos;"></tr>
    </table>

    <div class="sin-documentos" *ngIf="documentosFiltrados.length === 0">
      <mat-icon>check_circle</mat-icon>
      <p>No hay documentos en este estado</p>
    </div>
  </div>

  <!-- Paginación documentos -->
  <mat-paginator *ngIf="vistaDocumentos && documentosFiltrados.length > 0"
    [length]="documentosFiltrados.length"
    [pageSize]="pageSizeDocumentos"
    [pageIndex]="pageIndexDocumentos"
    [pageSizeOptions]="[10, 20, 50]"
    (page)="onPageChangeDocumentos($event)"
    showFirstLastButtons>
  </mat-paginator>

</div>
