<div class="roles-page">
  <div class="page-header">
    <div class="header-left">
      <button mat-icon-button (click)="goBack()" class="back-button" matTooltip="Volver al Dashboard">
        <mat-icon>arrow_back</mat-icon>
      </button>
      <div class="header-info">
        <h1>Gestión de Roles</h1>
        <p class="subtitle">Administra los roles y permisos del sistema</p>
      </div>
    </div>
    <button mat-raised-button color="primary" (click)="openRolDialog()">
      <mat-icon>add</mat-icon>
      Nuevo Rol
    </button>
  </div>

  <div *ngIf="loading" class="loading-container">
    <p>Cargando roles...</p>
  </div>

  <mat-card *ngIf="!loading" class="roles-card">
    <mat-card-header>
      <mat-icon mat-card-avatar>admin_panel_settings</mat-icon>
      <mat-card-title>Lista de Roles</mat-card-title>
      <mat-card-subtitle>{{ rolesFiltrados.length }} rol(es) encontrado(s)</mat-card-subtitle>
    </mat-card-header>
    <mat-card-content>
      <!-- Barra de búsqueda -->
      <div class="search-bar">
        <mat-icon>search</mat-icon>
        <input type="text"
               placeholder="Buscar por nombre o código..."
               [(ngModel)]="searchTerm"
               (input)="filterRoles()">
        <button mat-icon-button *ngIf="searchTerm" (click)="limpiarBusqueda()" matTooltip="Limpiar búsqueda">
          <mat-icon>close</mat-icon>
        </button>
      </div>

      <table mat-table [dataSource]="rolesFiltrados" class="roles-table" *ngIf="rolesFiltrados.length > 0">
        <!-- Nombre Column -->
        <ng-container matColumnDef="nombre">
          <th mat-header-cell *matHeaderCellDef>Nombre del Rol</th>
          <td mat-cell *matCellDef="let rol">
            <span class="rol-nombre">{{ rol.nombre }}</span>
          </td>
        </ng-container>

        <!-- Nivel Jerarquía Column -->
        <ng-container matColumnDef="nivelJerarquia">
          <th mat-header-cell *matHeaderCellDef>Nivel</th>
          <td mat-cell *matCellDef="let rol">
            {{ getNivelLabel(rol.nivelJerarquia) }}
          </td>
        </ng-container>

        <!-- Requiere Tenant Column -->
        <ng-container matColumnDef="requiereTenant">
          <th mat-header-cell *matHeaderCellDef>Alcance</th>
          <td mat-cell *matCellDef="let rol">
            <div class="tenant-cell">
              <mat-icon [class.tenant-required]="rol.requiereTenant" [class.tenant-global]="!rol.requiereTenant">
                {{ rol.requiereTenant ? 'business' : 'public' }}
              </mat-icon>
              <span>{{ rol.requiereTenant ? 'Por Empresa' : 'Global' }}</span>
            </div>
          </td>
        </ng-container>

        <!-- Cantidad Usuarios Column -->
        <ng-container matColumnDef="usuarios">
          <th mat-header-cell *matHeaderCellDef>Usuarios</th>
          <td mat-cell *matCellDef="let rol">
            <div class="usuarios-count">
              <mat-icon>people</mat-icon>
              <span>{{ rol.cantidadUsuarios }}</span>
            </div>
          </td>
        </ng-container>

        <!-- Estado Column -->
        <ng-container matColumnDef="activo">
          <th mat-header-cell *matHeaderCellDef>Estado</th>
          <td mat-cell *matCellDef="let rol">
            <mat-chip [class.chip-activo]="rol.activo" [class.chip-inactivo]="!rol.activo">
              {{ rol.activo ? 'ACTIVO' : 'INACTIVO' }}
            </mat-chip>
          </td>
        </ng-container>

        <!-- Acciones Column -->
        <ng-container matColumnDef="acciones">
          <th mat-header-cell *matHeaderCellDef>Acciones</th>
          <td mat-cell *matCellDef="let rol">
            <div class="acciones">
              <button mat-icon-button color="primary" (click)="openRolDialog(rol)" matTooltip="Editar rol">
                <mat-icon>edit</mat-icon>
              </button>
              <button mat-icon-button
                      (click)="toggleEstadoRol(rol)"
                      [matTooltip]="rol.activo ? 'Desactivar rol' : 'Activar rol'"
                      [color]="rol.activo ? 'warn' : 'accent'">
                <mat-icon>{{ rol.activo ? 'block' : 'check_circle' }}</mat-icon>
              </button>
              <button mat-icon-button color="warn" (click)="deleteRol(rol)" matTooltip="Eliminar rol"
                      [disabled]="rol.cantidadUsuarios > 0">
                <mat-icon>delete</mat-icon>
              </button>
            </div>
          </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
        <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
      </table>

      <div *ngIf="rolesFiltrados.length === 0 && !loading" class="no-roles">
        <mat-icon>{{ searchTerm ? 'search_off' : 'security' }}</mat-icon>
        <p *ngIf="!searchTerm">No hay roles configurados en el sistema.</p>
        <p *ngIf="searchTerm">No se encontraron roles con "{{ searchTerm }}"</p>
        <button mat-stroked-button color="primary" (click)="limpiarBusqueda()" *ngIf="searchTerm">
          <mat-icon>clear</mat-icon>
          Limpiar búsqueda
        </button>
      </div>
    </mat-card-content>
  </mat-card>

  <!-- Información adicional -->
  <div class="info-card" *ngIf="!loading">
    <mat-icon>info</mat-icon>
    <div class="info-content">
      <h3>Información sobre Roles</h3>
      <ul>
        <li><strong>Nivel 1:</strong> Super Administrador - Acceso completo sin restricciones de empresa</li>
        <li><strong>Nivel 2:</strong> Administrador de Empresa Principal - Gestiona una empresa y sus contratistas</li>
        <li><strong>Nivel 3:</strong> Administrador de Contratista - Gestiona una empresa contratista</li>
        <li><strong>Nivel 4:</strong> Usuarios - Acceso limitado según permisos asignados</li>
      </ul>
      <p class="warning">
        <mat-icon>warning</mat-icon>
        No se pueden eliminar roles que tengan usuarios asignados
      </p>
    </div>
  </div>
</div>
