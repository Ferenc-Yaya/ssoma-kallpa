<h2 mat-dialog-title>
  <mat-icon>{{ isViewOnly ? 'person' : (isEdit ? 'edit' : 'security') }}</mat-icon>
  {{ isViewOnly ? 'Datos del Usuario' : (isEdit ? 'Editar Usuario' : 'Nuevo Super Administrador') }}
</h2>

<mat-dialog-content>
  <form [formGroup]="usuarioForm" class="usuario-form">

    <!-- Username -->
    <div class="form-field">
      <label>
        Nombre de Usuario *
        <span class="hint-inline" *ngIf="!isEdit && !isViewOnly">(no se puede cambiar después)</span>
      </label>
      <input type="text"
             formControlName="username"
             placeholder="ejemplo: juan.perez"
             maxlength="50"
             [class.disabled-field]="isViewOnly">
      <small class="hint" *ngIf="!isEdit && !isViewOnly">Solo letras minúsculas, números, puntos, guiones</small>
      <small class="error" *ngIf="usuarioForm.get('username')?.invalid && usuarioForm.get('username')?.touched">
        {{ getErrorMessage('username') }}
      </small>
    </div>

    <!-- Nombre Completo -->
    <div class="form-field">
      <label>Nombre Completo *</label>
      <input type="text"
             formControlName="nombreCompleto"
             placeholder="Nombre y apellidos completos"
             maxlength="100"
             [readonly]="isViewOnly"
             [class.disabled-field]="isViewOnly">
      <small class="error" *ngIf="usuarioForm.get('nombreCompleto')?.invalid && usuarioForm.get('nombreCompleto')?.touched">
        {{ getErrorMessage('nombreCompleto') }}
      </small>
    </div>

    <!-- Email -->
    <div class="form-field">
      <label>Email *</label>
      <input type="email"
             formControlName="email"
             placeholder="correo@ejemplo.com"
             [readonly]="isViewOnly"
             [class.disabled-field]="isViewOnly">
      <small class="error" *ngIf="usuarioForm.get('email')?.invalid && usuarioForm.get('email')?.touched">
        {{ getErrorMessage('email') }}
      </small>
    </div>

    <!-- Password (solo en creación) -->
    <div class="form-row" *ngIf="showPasswordFields">
      <div class="form-field">
        <label>Contraseña *</label>
        <div class="password-input-wrapper">
          <input
            [type]="showPassword ? 'text' : 'password'"
            formControlName="password"
            placeholder="Mínimo 8 caracteres"
            autocomplete="new-password">
          <div class="password-toggles">
            <mat-icon (click)="generatePassword()">autorenew</mat-icon>
            <mat-icon (click)="togglePasswordVisibility()">{{ showPassword ? 'visibility_off' : 'visibility' }}</mat-icon>
          </div>
        </div>
        <small class="error" *ngIf="usuarioForm.get('password')?.invalid && usuarioForm.get('password')?.touched">
          {{ getErrorMessage('password') }}
        </small>
      </div>

      <div class="form-field">
        <label>Confirmar Contraseña *</label>
        <div class="password-input-wrapper">
          <input
            [type]="showConfirmPassword ? 'text' : 'password'"
            formControlName="confirmPassword"
            placeholder="Repetir contraseña"
            autocomplete="new-password">
          <div class="password-toggles">
            <mat-icon (click)="toggleConfirmPasswordVisibility()">{{ showConfirmPassword ? 'visibility_off' : 'visibility' }}</mat-icon>
          </div>
        </div>
        <small class="error" *ngIf="!passwordsMatch() && usuarioForm.get('confirmPassword')?.touched && usuarioForm.get('confirmPassword')?.value">
          <mat-icon>error</mat-icon>
          Las contraseñas no coinciden
        </small>
        <small class="success" *ngIf="passwordsMatch() && usuarioForm.get('confirmPassword')?.value">
          <mat-icon>check_circle</mat-icon>
          Las contraseñas coinciden
        </small>
      </div>
    </div>

    <!-- Rol -->
    <div class="form-field">
      <label>Rol / Grupo de Usuario *</label>
      <!-- En modo viewOnly o isCreate, mostrar como readonly -->
      <input *ngIf="isViewOnly || isCreate" type="text" [value]="getRolNombre()" readonly class="disabled-field">
      <!-- En modo edición normal, mostrar select -->
      <select *ngIf="!isViewOnly && !isCreate" formControlName="rolId">
        <option value="" disabled>Seleccionar rol...</option>
        <option *ngFor="let rol of roles" [value]="rol.rolId">
          {{ rol.nombre }}
        </option>
      </select>
      <small class="hint" *ngIf="isCreate">
        <mat-icon>security</mat-icon>
        Este formulario es exclusivo para crear Super Administradores
      </small>
      <small class="hint" *ngIf="usuarioForm.get('rolId')?.value && !isViewOnly && !isCreate">
        <mat-icon>info</mat-icon>
        {{ getRolDescription(usuarioForm.get('rolId')?.value) }}
      </small>
      <small class="error" *ngIf="usuarioForm.get('rolId')?.invalid && usuarioForm.get('rolId')?.touched">
        {{ getErrorMessage('rolId') }}
      </small>
    </div>

    <!-- Tenant (solo si el rol lo requiere, es SUPER_ADMIN, o en modo viewOnly/edit con tenantId) -->
    <div class="form-field" *ngIf="requiereTenant() || isSuperAdminSelected || ((isViewOnly || disableTenant) && data.usuario?.tenantId)">
      <label>Empresa Principal {{ isSuperAdminSelected ? '' : '*' }}</label>
      <!-- Mostrar input readonly para: viewOnly, disableTenant, o SUPER_ADMIN seleccionado -->
      <input *ngIf="isViewOnly || disableTenant || isSuperAdminSelected"
             type="text"
             [value]="isSuperAdminSelected ? 'SYSTEM (Sistema Central)' : data.usuario?.tenantId"
             readonly
             class="disabled-field">
      <!-- Mostrar select solo si: no es viewOnly, no es disableTenant, y no es SUPER_ADMIN -->
      <select *ngIf="!isViewOnly && !disableTenant && !isSuperAdminSelected" formControlName="tenantId">
        <option value="" disabled>Seleccionar empresa...</option>
        <option *ngFor="let empresa of empresasPrincipales" [value]="empresa.tenantId">
          {{ empresa.nombre }} ({{ empresa.tenantId }})
        </option>
      </select>
      <small class="hint" *ngIf="isSuperAdminSelected && !isViewOnly">
        <mat-icon>security</mat-icon>
        Los Super Administradores siempre pertenecen al Sistema Central
      </small>
      <small class="hint" *ngIf="disableTenant && !isViewOnly && !isSuperAdminSelected">
        <mat-icon>lock</mat-icon>
        La empresa principal no se puede modificar
      </small>
      <small class="hint" *ngIf="!disableTenant && !isViewOnly && !isSuperAdminSelected && requiereTenant()">
        <mat-icon>domain</mat-icon>
        El usuario tendrá acceso solo a esta empresa
      </small>
      <small class="error" *ngIf="usuarioForm.get('tenantId')?.invalid && usuarioForm.get('tenantId')?.touched">
        {{ getErrorMessage('tenantId') }}
      </small>
    </div>

    <!-- Estado -->
    <div class="form-field" *ngIf="isViewOnly">
      <label>Estado</label>
      <input type="text" [value]="usuarioForm.get('activo')?.value ? 'ACTIVO' : 'INACTIVO'" readonly class="disabled-field">
    </div>
    <div class="checkbox-field" *ngIf="!isViewOnly">
      <label class="checkbox-container">
        <input type="checkbox" formControlName="activo">
        <span class="checkbox-label">
          <mat-icon>{{ usuarioForm.get('activo')?.value ? 'check_circle' : 'block' }}</mat-icon>
          Usuario activo
        </span>
      </label>
      <small class="hint">Los usuarios inactivos no pueden acceder al sistema</small>
    </div>

  </form>
</mat-dialog-content>

<mat-dialog-actions align="end">
  <button mat-button (click)="onCancel()">
    <mat-icon>close</mat-icon>
    {{ isViewOnly ? 'Cerrar' : 'Cancelar' }}
  </button>
  <button mat-raised-button
          color="primary"
          (click)="onSubmit()"
          [disabled]="usuarioForm.invalid || (!passwordsMatch() && showPasswordFields)"
          *ngIf="!isViewOnly">
    <mat-icon>{{ isEdit ? 'save' : 'security' }}</mat-icon>
    {{ isEdit ? 'Guardar Cambios' : 'Crear Super Admin' }}
  </button>
</mat-dialog-actions>
