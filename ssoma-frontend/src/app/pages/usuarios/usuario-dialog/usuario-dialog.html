<h2 mat-dialog-title>
  <mat-icon>{{ isEdit ? 'edit' : 'person_add' }}</mat-icon>
  {{ isEdit ? 'Editar Usuario' : 'Nuevo Usuario' }}
</h2>

<mat-dialog-content>
  <form [formGroup]="usuarioForm" class="usuario-form">

    <!-- Username -->
    <div class="form-field">
      <label>
        Nombre de Usuario *
        <span class="hint-inline" *ngIf="!isEdit">(no se puede cambiar después)</span>
      </label>
      <input type="text"
             formControlName="username"
             placeholder="ejemplo: juan.perez"
             maxlength="50">
      <small class="hint" *ngIf="!isEdit">Solo letras minúsculas, números, puntos, guiones</small>
      <small class="error" *ngIf="usuarioForm.get('username')?.invalid && usuarioForm.get('username')?.touched">
        {{ getErrorMessage('username') }}
      </small>
    </div>

    <!-- Nombre Completo -->
    <div class="form-field">
      <label>Nombre Completo *</label>
      <input type="text"
             formControlName="nombreCompleto"
             placeholder="Nombre y apellidos completos"
             maxlength="100">
      <small class="error" *ngIf="usuarioForm.get('nombreCompleto')?.invalid && usuarioForm.get('nombreCompleto')?.touched">
        {{ getErrorMessage('nombreCompleto') }}
      </small>
    </div>

    <!-- Email -->
    <div class="form-field">
      <label>Email *</label>
      <input type="email"
             formControlName="email"
             placeholder="correo@ejemplo.com">
      <small class="error" *ngIf="usuarioForm.get('email')?.invalid && usuarioForm.get('email')?.touched">
        {{ getErrorMessage('email') }}
      </small>
    </div>

    <!-- Password (solo en creación) -->
    <div class="form-row" *ngIf="showPasswordFields">
      <div class="form-field">
        <label>Contraseña *</label>
        <input type="password"
               formControlName="password"
               placeholder="Mínimo 8 caracteres"
               autocomplete="new-password">
        <small class="error" *ngIf="usuarioForm.get('password')?.invalid && usuarioForm.get('password')?.touched">
          {{ getErrorMessage('password') }}
        </small>
      </div>

      <div class="form-field">
        <label>Confirmar Contraseña *</label>
        <input type="password"
               formControlName="confirmPassword"
               placeholder="Repetir contraseña"
               autocomplete="new-password">
        <small class="error" *ngIf="!passwordsMatch() && usuarioForm.get('confirmPassword')?.touched">
          Las contraseñas no coinciden
        </small>
      </div>
    </div>

    <!-- Rol -->
    <div class="form-field">
      <label>Rol / Grupo de Usuario *</label>
      <select formControlName="rolId">
        <option value="" disabled>Seleccionar rol...</option>
        <option *ngFor="let rol of roles" [value]="rol.rolId">
          {{ rol.nombre }}
        </option>
      </select>
      <small class="hint" *ngIf="usuarioForm.get('rolId')?.value">
        <mat-icon>info</mat-icon>
        {{ getRolDescription(usuarioForm.get('rolId')?.value) }}
      </small>
      <small class="error" *ngIf="usuarioForm.get('rolId')?.invalid && usuarioForm.get('rolId')?.touched">
        {{ getErrorMessage('rolId') }}
      </small>
    </div>

    <!-- Tenant (solo si el rol lo requiere) -->
    <div class="form-field" *ngIf="requiereTenant()">
      <label>Empresa Principal *</label>
      <select formControlName="tenantId">
        <option value="" disabled>Seleccionar empresa...</option>
        <option *ngFor="let empresa of empresasPrincipales" [value]="empresa.tenantId">
          {{ empresa.nombre }} ({{ empresa.tenantId }})
        </option>
      </select>
      <small class="hint">
        <mat-icon>domain</mat-icon>
        El usuario tendrá acceso solo a esta empresa
      </small>
      <small class="error" *ngIf="usuarioForm.get('tenantId')?.invalid && usuarioForm.get('tenantId')?.touched">
        {{ getErrorMessage('tenantId') }}
      </small>
    </div>

    <!-- Estado -->
    <div class="checkbox-field">
      <label class="checkbox-container">
        <input type="checkbox" formControlName="activo">
        <span class="checkbox-label">
          <mat-icon>{{ usuarioForm.get('activo')?.value ? 'check_circle' : 'block' }}</mat-icon>
          Usuario activo
        </span>
      </label>
      <small class="hint">Los usuarios inactivos no pueden acceder al sistema</small>
    </div>

  </form>
</mat-dialog-content>

<mat-dialog-actions align="end">
  <button mat-button (click)="onCancel()">
    <mat-icon>close</mat-icon>
    Cancelar
  </button>
  <button mat-raised-button
          color="primary"
          (click)="onSubmit()"
          [disabled]="usuarioForm.invalid || (!passwordsMatch() && showPasswordFields)">
    <mat-icon>{{ isEdit ? 'save' : 'person_add' }}</mat-icon>
    {{ isEdit ? 'Guardar Cambios' : 'Crear Usuario' }}
  </button>
</mat-dialog-actions>
