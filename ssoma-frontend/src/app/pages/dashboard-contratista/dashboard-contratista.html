<div class="dashboard-contratista">

  <!-- Header -->
  <div class="header">
    <h1>{{ nombreEmpresa }}</h1>
    <p class="subtitle">Mis Contratos y Estado de Cumplimiento</p>
  </div>

  <!-- Resumen de estados -->
  <div class="resumen-estados" *ngIf="todosLosContratos.length > 0">
    <div class="estado-card nuevo" (click)="filtroEstado = 'nuevo'; onFiltroChange()" *ngIf="resumenEstados.nuevos > 0">
      <span class="numero">{{ resumenEstados.nuevos }}</span>
      <span class="label">Nuevos</span>
    </div>
    <div class="estado-card atencion" (click)="filtroEstado = 'atencion'; onFiltroChange()" *ngIf="resumenEstados.requierenAtencion > 0">
      <span class="numero">{{ resumenEstados.requierenAtencion }}</span>
      <span class="label">Req. Atención</span>
    </div>
    <div class="estado-card verde" (click)="filtroEstado = 'habilitado'; onFiltroChange()">
      <span class="numero">{{ resumenEstados.habilitados }}</span>
      <span class="label">Habilitados</span>
    </div>
    <div class="estado-card amarillo" (click)="filtroEstado = 'parcial'; onFiltroChange()">
      <span class="numero">{{ resumenEstados.parciales }}</span>
      <span class="label">Parciales</span>
    </div>
    <div class="estado-card gris" (click)="filtroEstado = 'finalizado'; onFiltroChange()">
      <span class="numero">{{ resumenEstados.finalizados }}</span>
      <span class="label">Finalizados</span>
    </div>
    <div class="estado-card total" (click)="filtroEstado = 'todos'; onFiltroChange()">
      <span class="numero">{{ resumenEstados.total }}</span>
      <span class="label">Total</span>
    </div>
  </div>

  <!-- Barra de búsqueda y filtros -->
  <div class="filtros-bar" *ngIf="todosLosContratos.length > 0">
    <div class="search-bar">
      <mat-icon>search</mat-icon>
      <input type="text"
             placeholder="Buscar por número, descripción o empresa..."
             [(ngModel)]="searchTerm"
             (ngModelChange)="onSearchChange()">
      <button mat-icon-button *ngIf="searchTerm" (click)="searchTerm = ''; onSearchChange()" matTooltip="Limpiar búsqueda">
        <mat-icon>close</mat-icon>
      </button>
    </div>

    <div class="filter-select">
      <mat-icon>filter_list</mat-icon>
      <select [(ngModel)]="filtroEstado" (ngModelChange)="onFiltroChange()">
        <option value="todos">Todos los estados</option>
        <option value="nuevo">Nuevo</option>
        <option value="atencion">Requiere Atención</option>
        <option value="habilitado">Habilitado</option>
        <option value="parcial">Parcial</option>
        <option value="finalizado">Finalizado</option>
      </select>
    </div>

    <span class="resultados-info">
      {{ contratosFiltrados.length }} de {{ todosLosContratos.length }} contratos
    </span>
  </div>

  <!-- Sin contratos -->
  <div class="sin-contratos" *ngIf="todosLosContratos.length === 0">
    <mat-icon>assignment</mat-icon>
    <h2>No tienes contratos asignados</h2>
    <p>Contacta con la empresa principal para que te asignen un contrato.</p>
  </div>

  <!-- Sin resultados de búsqueda -->
  <div class="sin-contratos" *ngIf="todosLosContratos.length > 0 && contratosFiltrados.length === 0">
    <mat-icon>search_off</mat-icon>
    <h2>No se encontraron contratos</h2>
    <p>Intenta con otros términos de búsqueda o cambia los filtros.</p>
  </div>

  <!-- Lista de contratos -->
  <div class="contratos-grid" *ngIf="contratosPaginados.length > 0">
    <mat-card *ngFor="let contrato of contratosPaginados" class="contrato-card" [class]="getSemaforoColor(contrato)">

      <!-- Header del contrato con semáforo -->
      <div class="contrato-header">
        <div class="semaforo-estado">
          <div class="semaforo" [class]="getSemaforoColor(contrato)">
            <div class="luz"></div>
          </div>
          <div class="estado-info">
            <span class="numero-contrato">{{ contrato.numero }}</span>
            <span class="estado-badge" [class]="getEstadoClass(contrato.estado)">
              {{ getEstadoLabel(contrato.estado) }}
            </span>
          </div>
        </div>
        <div class="cumplimiento-badge" [class]="getSemaforoColor(contrato)">
          <span class="porcentaje">{{ contrato.porcentajeCumplimiento }}%</span>
        </div>
      </div>

      <!-- Info del contrato -->
      <div class="contrato-info">
        <h3>{{ contrato.descripcion }}</h3>
        <div class="meta-info">
          <span class="empresa">
            <mat-icon>business</mat-icon>
            {{ contrato.empresaPrincipal }}
          </span>
          <span class="fechas">
            <mat-icon>date_range</mat-icon>
            {{ contrato.fechaInicio }} - {{ contrato.fechaFin }}
          </span>
        </div>
      </div>

      <!-- Alerta de documentos observados -->
      <div class="alerta-observados" *ngIf="contrato.observacionesPendientes > 0">
        <mat-icon>visibility</mat-icon>
        <div class="alerta-texto">
          <span class="alerta-titulo">{{ contrato.observacionesPendientes }} documento{{ contrato.observacionesPendientes > 1 ? 's' : '' }} observado{{ contrato.observacionesPendientes > 1 ? 's' : '' }}</span>
          <span class="alerta-descripcion">Documentos en validación - Revisar observaciones</span>
        </div>
        <mat-icon class="alerta-arrow">chevron_right</mat-icon>
      </div>

      <!-- Recursos del contrato -->
      <div class="recursos-lista">
        <div *ngFor="let recurso of contrato.recursos" class="recurso-fila"
             [class.tiene-vencidos]="recurso.vencidos > 0"
             [class.oculto]="recurso.total === 0">
          <div class="recurso-info">
            <mat-icon>{{ recurso.icono }}</mat-icon>
            <span class="nombre">{{ recurso.nombre }}</span>
          </div>
          <div class="recurso-barra">
            <div class="barra-bg">
              <div class="barra-fill" [style.width.%]="getPorcentajeRecurso(recurso)"
                   [class.verde]="getPorcentajeRecurso(recurso) >= 90"
                   [class.amarillo]="getPorcentajeRecurso(recurso) >= 70 && getPorcentajeRecurso(recurso) < 90"
                   [class.rojo]="getPorcentajeRecurso(recurso) < 70"></div>
            </div>
          </div>
          <div class="recurso-numeros">
            <span class="cantidad">{{ recurso.habilitados }}/{{ recurso.total }}</span>
          </div>
          <div class="recurso-alertas">
            <span class="vencidos" *ngIf="recurso.vencidos > 0">{{ recurso.vencidos }} venc.</span>
            <span class="por-vencer" *ngIf="recurso.porVencer > 0">{{ recurso.porVencer }} x vencer</span>
            <span class="ok" *ngIf="recurso.vencidos === 0 && recurso.porVencer === 0">✓</span>
          </div>
        </div>
      </div>

      <!-- Acción del contrato -->
      <div class="contrato-acciones">
        <button mat-flat-button color="primary" class="btn-gestionar" (click)="gestionarContrato(contrato)">
          <mat-icon>edit</mat-icon>
          Gestionar Contrato
        </button>
        <button mat-stroked-button
                color="accent"
                class="btn-pasaporte"
                [disabled]="contrato.estado !== 'habilitado' && contrato.estado !== 'finalizado'"
                (click)="verPasaporte(contrato)">
          <mat-icon>badge</mat-icon>
          Ver Pasaporte
        </button>
      </div>

    </mat-card>
  </div>

  <!-- Paginación -->
  <mat-paginator *ngIf="contratosFiltrados.length > pageSize"
    [length]="contratosFiltrados.length"
    [pageSize]="pageSize"
    [pageIndex]="pageIndex"
    [pageSizeOptions]="[6, 12, 24]"
    (page)="onPageChange($event)"
    showFirstLastButtons>
  </mat-paginator>

</div>
