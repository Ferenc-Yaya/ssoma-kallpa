<div class="acreditacion-page">
  <div class="acreditacion-header">
    <button mat-icon-button class="btn-volver" (click)="volverALista()">
      <mat-icon>arrow_back</mat-icon>
    </button>

    <div class="header-info" *ngIf="contrato">
      <div class="header-title">
        <h1>{{ contrato.numero_contrato }}</h1>
        <p class="empresa-nombre">{{ contrato.empresa_nombre }}</p>
        <p class="descripcion">{{ contrato.descripcion }}</p>
      </div>

      <div class="header-badges">
        <div class="custom-chip" [style.background-color]="getNivelRiesgoColor(contrato.nivel_riesgo)">
          Riesgo: {{ contrato.nivel_riesgo }}
        </div>
        <div class="custom-chip" [style.background-color]="getEstadoColor(contrato.estado_acreditacion)">
          {{ contrato.estado_acreditacion }}
        </div>
      </div>
    </div>

    <div class="progreso-general" *ngIf="contrato">
      <div class="progreso-stats">
        <div class="stat-item">
          <span class="stat-label">Aprobados</span>
          <span class="stat-value green">{{ contrato.progreso.docs_aprobados }}</span>
        </div>
        <div class="stat-item">
          <span class="stat-label">Rechazados</span>
          <span class="stat-value red">{{ contrato.progreso.docs_rechazados }}</span>
        </div>
        <div class="stat-item">
          <span class="stat-label">Pendientes</span>
          <span class="stat-value orange">{{ contrato.progreso.docs_pendientes }}</span>
        </div>
        <div class="stat-item">
          <span class="stat-label">Progreso</span>
          <span class="stat-value blue">{{ contrato.progreso.porcentaje }}%</span>
        </div>
      </div>
      <mat-progress-bar 
        mode="determinate" 
        [value]="contrato.progreso.porcentaje"
        [color]="contrato.progreso.porcentaje === 100 ? 'accent' : 'primary'">
      </mat-progress-bar>
    </div>
  </div>

  <div class="loading-container" *ngIf="loading">
    <mat-progress-bar mode="indeterminate"></mat-progress-bar>
    <p>Cargando contrato...</p>
  </div>

  <div class="split-container" *ngIf="contrato && !loading">
    <div class="panel-izquierdo">
      <div class="panel-header">
        <h2>
          <mat-icon>folder_open</mat-icon>
          Recursos del Contrato
        </h2>
      </div>

      <div class="recursos-tree">
        <mat-expansion-panel class="recurso-panel" [expanded]="true">
          <mat-expansion-panel-header>
            <mat-panel-title>
              <mat-icon class="recurso-icon">people</mat-icon>
              <span class="recurso-title">Personas ({{ contrato.personas.length }})</span>
            </mat-panel-title>
          </mat-expansion-panel-header>

          <div class="recurso-content">
            <mat-expansion-panel class="entidad-panel" *ngFor="let persona of contrato.personas">
              <mat-expansion-panel-header>
                <mat-panel-title>
                  <img [src]="persona.foto_url" [alt]="persona.nombre_completo" class="persona-foto-mini">
                  <div class="entidad-info">
                    <span class="entidad-nombre">{{ persona.nombre_completo }}</span>
                    <small class="entidad-detalle">{{ persona.dni }} - {{ persona.cargo }}</small>
                  </div>
                </mat-panel-title>
              </mat-expansion-panel-header>

              <div class="documentos-list">
                <div class="documento-item" 
                     *ngFor="let doc of persona.documentos"
                     [class.selected]="documentoSeleccionado?.documento_id === doc.documento_id"
                     (click)="seleccionarDocumento(doc, 'PERSONA', persona.nombre_completo, persona.foto_url)">
                  <mat-icon 
                    class="doc-status-icon"
                    [style.color]="getEstadoColor(doc.estado_revision)">
                    {{ getEstadoIcon(doc.estado_revision) }}
                  </mat-icon>
                  <div class="doc-info">
                    <span class="doc-nombre">{{ doc.nombre }}</span>
                    <small class="doc-obligatorio" *ngIf="doc.obligatorio">*Obligatorio</small>
                  </div>
                  <mat-icon class="doc-arrow" *ngIf="doc.archivo_url">chevron_right</mat-icon>
                </div>
              </div>
            </mat-expansion-panel>
          </div>
        </mat-expansion-panel>

        <mat-expansion-panel class="recurso-panel" [expanded]="true">
          <mat-expansion-panel-header>
            <mat-panel-title>
              <mat-icon class="recurso-icon">directions_car</mat-icon>
              <span class="recurso-title">Activos ({{ contrato.activos.length }})</span>
            </mat-panel-title>
          </mat-expansion-panel-header>

          <div class="recurso-content">
            <mat-expansion-panel class="entidad-panel" *ngFor="let activo of contrato.activos">
              <mat-expansion-panel-header>
                <mat-panel-title>
                  <mat-icon class="tipo-icon">
                    {{ activo.tipo === 'VEHICULO' ? 'local_shipping' : 'build' }}
                  </mat-icon>
                  <div class="entidad-info">
                    <span class="entidad-nombre">{{ activo.descripcion }}</span>
                    <small class="entidad-detalle">{{ activo.codigo }} - {{ activo.marca }} {{ activo.modelo }}</small>
                  </div>
                </mat-panel-title>
              </mat-expansion-panel-header>

              <div class="documentos-list">
                <div class="documento-item" 
                     *ngFor="let doc of activo.documentos"
                     [class.selected]="documentoSeleccionado?.documento_id === doc.documento_id"
                     (click)="seleccionarDocumento(doc, 'ACTIVO', activo.descripcion)">
                  <mat-icon 
                    class="doc-status-icon"
                    [style.color]="getEstadoColor(doc.estado_revision)">
                    {{ getEstadoIcon(doc.estado_revision) }}
                  </mat-icon>
                  <div class="doc-info">
                    <span class="doc-nombre">{{ doc.nombre }}</span>
                    <small class="doc-obligatorio" *ngIf="doc.obligatorio">*Obligatorio</small>
                  </div>
                  <mat-icon class="doc-arrow" *ngIf="doc.archivo_url">chevron_right</mat-icon>
                </div>
              </div>
            </mat-expansion-panel>
          </div>
        </mat-expansion-panel>

        <mat-expansion-panel class="recurso-panel" *ngIf="contrato.materiales.length > 0">
          <mat-expansion-panel-header>
            <mat-panel-title>
              <mat-icon class="recurso-icon">warning</mat-icon>
              <span class="recurso-title">Materiales Peligrosos ({{ contrato.materiales.length }})</span>
            </mat-panel-title>
          </mat-expansion-panel-header>

          <div class="recurso-content">
            <mat-expansion-panel class="entidad-panel" *ngFor="let material of contrato.materiales">
              <mat-expansion-panel-header>
                <mat-panel-title>
                  <mat-icon class="tipo-icon">science</mat-icon>
                  <div class="entidad-info">
                    <span class="entidad-nombre">{{ material.nombre_sustancia }}</span>
                    <small class="entidad-detalle">{{ material.codigo_un }} - {{ material.cantidad }} {{ material.unidad_medida }}</small>
                  </div>
                </mat-panel-title>
              </mat-expansion-panel-header>

              <div class="documentos-list">
                <div class="documento-item" 
                     *ngFor="let doc of material.documentos"
                     [class.selected]="documentoSeleccionado?.documento_id === doc.documento_id"
                     (click)="seleccionarDocumento(doc, 'MATERIAL', material.nombre_sustancia)">
                  <mat-icon 
                    class="doc-status-icon"
                    [style.color]="getEstadoColor(doc.estado_revision)">
                    {{ getEstadoIcon(doc.estado_revision) }}
                  </mat-icon>
                  <div class="doc-info">
                    <span class="doc-nombre">{{ doc.nombre }}</span>
                    <small class="doc-obligatorio" *ngIf="doc.obligatorio">*Obligatorio</small>
                  </div>
                  <mat-icon class="doc-arrow" *ngIf="doc.archivo_url">chevron_right</mat-icon>
                </div>
              </div>
            </mat-expansion-panel>
          </div>
        </mat-expansion-panel>

        <div class="no-materiales" *ngIf="contrato.materiales.length === 0">
          <mat-icon>check_circle</mat-icon>
          <p>Este contrato no involucra materiales peligrosos</p>
        </div>
      </div>
    </div>

    <div class="panel-derecho">
      <div class="empty-state" *ngIf="!documentoSeleccionado">
        <mat-icon>description</mat-icon>
        <h3>Selecciona un documento</h3>
        <p>Haz clic en cualquier documento del panel izquierdo para visualizarlo y revisarlo</p>
      </div>

      <div class="documento-viewer" *ngIf="documentoSeleccionado">
        <div class="viewer-header">
          <div class="doc-header-info">
            <img *ngIf="entidadSeleccionada?.foto" 
                 [src]="entidadSeleccionada?.foto" 
                 [alt]="entidadSeleccionada?.nombre"
                 class="entidad-foto">
            <mat-icon *ngIf="!entidadSeleccionada?.foto && entidadSeleccionada?.tipo === 'ACTIVO'">
              local_shipping
            </mat-icon>
            <mat-icon *ngIf="!entidadSeleccionada?.foto && entidadSeleccionada?.tipo === 'MATERIAL'">
              science
            </mat-icon>
            <div class="doc-header-text">
              <h3>{{ documentoSeleccionado.nombre }}</h3>
              <p>{{ entidadSeleccionada?.tipo }}: {{ entidadSeleccionada?.nombre }}</p>
            </div>
          </div>

          <mat-chip 
            [style.background-color]="getEstadoColor(documentoSeleccionado.estado_revision)"
            style="color: white;">
            <mat-icon>{{ getEstadoIcon(documentoSeleccionado.estado_revision) }}</mat-icon>
            {{ documentoSeleccionado.estado_revision }}
          </mat-chip>
        </div>

        <div class="doc-metadata">
          <div class="metadata-item" *ngIf="documentoSeleccionado.fecha_emision">
            <mat-icon>event</mat-icon>
            <div>
              <label>Fecha Emisión</label>
              <p>{{ documentoSeleccionado.fecha_emision | date:'dd/MM/yyyy' }}</p>
            </div>
          </div>

          <div class="metadata-item" *ngIf="documentoSeleccionado.fecha_vencimiento">
            <mat-icon>event_available</mat-icon>
            <div>
              <label>Fecha Vencimiento</label>
              <p>{{ documentoSeleccionado.fecha_vencimiento | date:'dd/MM/yyyy' }}</p>
            </div>
          </div>

          <div class="metadata-item" *ngIf="documentoSeleccionado.fecha_revision">
            <mat-icon>person</mat-icon>
            <div>
              <label>Revisado por</label>
              <p>{{ documentoSeleccionado.revisor_nombre }}</p>
              <small>{{ documentoSeleccionado.fecha_revision | date:'dd/MM/yyyy HH:mm' }}</small>
            </div>
          </div>
        </div>

        <div class="pdf-viewer" *ngIf="documentoSeleccionado.archivo_url">
          <iframe 
            [src]="documentoSeleccionado.archivo_url" 
            frameborder="0"
            class="pdf-frame">
          </iframe>
        </div>

        <div class="no-archivo" *ngIf="!documentoSeleccionado.archivo_url">
          <mat-icon>cloud_upload</mat-icon>
          <p>El trabajador aún no ha subido este documento</p>
          <small>Estado: {{ documentoSeleccionado.estado_revision }}</small>
        </div>

        <div class="motivo-rechazo-display" *ngIf="documentoSeleccionado.estado_revision === 'RECHAZADO' && documentoSeleccionado.motivo_rechazo">
          <mat-icon>error</mat-icon>
          <div>
            <label>Motivo del Rechazo</label>
            <p>{{ documentoSeleccionado.motivo_rechazo }}</p>
          </div>
        </div>

        <div class="rechazo-form" *ngIf="documentoSeleccionado.archivo_url && documentoSeleccionado.estado_revision !== 'APROBADO'">
          <mat-form-field appearance="outline" class="motivo-field">
            <mat-label>Motivo del rechazo (obligatorio para rechazar)</mat-label>
            <textarea 
              matInput 
              [(ngModel)]="motivoRechazo"
              rows="3"
              placeholder="Ejemplo: Falta vacuna contra Hepatitis B"></textarea>
          </mat-form-field>
        </div>

        <!-- Botones de acción -->
        <div class="action-buttons" *ngIf="documentoSeleccionado.archivo_url">
          <button 
            mat-raised-button 
            color="primary"
            class="btn-aprobar"
            [disabled]="documentoSeleccionado.estado_revision === 'APROBADO'"
            (click)="aprobarDocumento()">
            ✓ APROBAR
          </button>

          <button 
            mat-raised-button 
            color="warn"
            class="btn-rechazar"
            [disabled]="!motivoRechazo.trim()"
            (click)="rechazarDocumento()">
            ✗ RECHAZAR
          </button>
        </div>
      </div>
    </div>
  </div>
</div>